name: Cleanup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 6'

permissions:
  packages: write

env:
  REPOSITORY: hyperion-project

jobs:
  clean:
    runs-on: ubuntu-latest
    name: ⏰ Scheduled cleanup
    steps:
      - name: ✅ Determine current Repository
        if: ${{ !startsWith(github.repository, env.REPOSITORY) }}
        run: echo "REPOSITORY=$(echo '${{ github.actor }}' | tr '[:upper:]' '[:lower:]')" >> ${GITHUB_ENV}

      - name: ⬇ Fetch multi-platform package version SHAs
        id: multi-arch-digests
        run: |
          UBUNTU=""
          for image in focal jammy mantic noble oracular; do
            RESPONSE=$(docker manifest inspect ghcr.io/${{ env.REPOSITORY }}/ubuntu:$image | jq -r '.manifests[].digest' | paste -s -d ' ' -);
            UBUNTU+=" ${RESPONSE}";
            echo "${UBUNTU}";
          done
          DEBIAN=""
          for image in buster bullseye bookworm trixie; do
            RESPONSE=$(docker manifest inspect ghcr.io/${{ env.REPOSITORY }}/debian:$image | jq -r '.manifests[].digest' | paste -s -d ' ' -);
            DEBIAN+=" ${RESPONSE}";
            echo "${DEBIAN}";
          done
          FEDORA=""
          for image in 39 40 41; do
            RESPONSE=$(docker manifest inspect ghcr.io/${{ env.REPOSITORY }}/fedora:$image | jq -r '.manifests[].digest' | paste -s -d ' ' -);
            FEDORA+=" ${RESPONSE}";
            echo "${FEDORA}";
          done
          echo "multi-arch-digests=$UBUNTU,$DEBIAN,$FEDORA" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.HYPERION_BOT_TOKEN }}

      - name: 🧹 Delete unused images
        # if: ${{ env.SECRET_BOT_TOKEN != null }}
        uses: snok/container-retention-policy@v3.0.0
        with:
          account: ${{ env.REPOSITORY }}
          token: ${{ secrets.HYPERION_BOT_TOKEN }}
          tag-selection: "untagged"
          cut-off: 1w
          dry-run: true
          rust-log: container_retention_policy=debug
          skip-shas: ${{ steps.multi-arch-digests.outputs.multi-arch-digests }}